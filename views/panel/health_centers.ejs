<!doctype html>
<html lang="fa-IR" dir="rtl">

<%- include("layout/head",{title:'پنل سامانه سلامت'}) %>

    <body class="app sidebar-mini rtl light-mode">
        <%- include('layout/switcher') %>
            <!-- GLOBAL-LOADER -->
            <div id="global-loader">
                <img src="/assets/images/loader.svg" class="loader-img" alt="Loader">
            </div>
            <!-- /GLOBAL-LOADER -->

            <!-- PAGE -->
            <div class="page">
                <div class="page-main">

                    <!-- app-Header -->
                    <%- include('layout/header',{login}) %>
                        <!-- /app-Header -->
                        <%- include('layout/sidebar') %>

                            <!--==========================Insert_Edit Modal=================================-->

                            <div class="modal fade" id="input-modal">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content modal-content-demo">
                                        <div class="modal-header">
                                            <h6 class="modal-title" id="_hModalTitle">افزودن مرکز سلامت</h6>
                                            <button class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">×</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form>
                                                <div class="mb-3">
                                                    <label for="province" class="col-form-label">استان:</label>
                                                    <input type="text" class="form-control" id="province" />
                                                </div>
                                                <div class="mb-3">
                                                    <label for="city" class="col-form-label">شهر:</label>
                                                    <input type="text" class="form-control" id="city" />
                                                </div>
                                                <div class="mb-3">
                                                    <label for="name" class="col-form-label">نام مرکز:</label>
                                                    <input type="text" class="form-control" id="name" />
                                                </div>
                                                <div class="mb-3">
                                                    <label for="village" class="col-form-label">روستا:</label>
                                                    <input type="text" class="form-control" id="village" />
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn ripple btn-success" id="regHCInfo" data-action="create"
                                                type="button">ثبت اطلاعات مرکز</button>
                                            <button class="btn ripple btn-danger" data-bs-dismiss="modal"
                                                type="button">بستن</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!--==========================Insert_Edit Modal=================================-->

                            <!--==========================Delete Modal=================================-->
                            <!-- MODAL Effects -->
                            <div class="modal fade" id="modaldemo8">
                                <div class="modal-dialog modal-dialog-centered text-center" role="document">
                                    <div class="modal-content modal-content-demo">
                                        <div class="modal-header">
                                            <h6 class="modal-title">حذف کاربر</h6><button aria-label="Close"
                                                class="btn-close" data-bs-dismiss="modal"><span
                                                    aria-hidden="true ">&times;</span></button>
                                        </div>
                                        <div class="modal-body">
                                            آیا با حذف این مرکز موافق هستید؟
                                        </div>

                                        <div class="modal-footer">
                                            <button class="btn btn-light deleteH">تایید</button> <button
                                                class="btn btn-danger" data-bs-dismiss="modal">لغو</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <style>
                                #modaldemo8 .modal-header {
                                    background-color: rgb(169 0 0 / 94%);
                                    border-bottom: 1px solid rgb(126 0 0) !important;
                                    color: white;
                                }

                                #modaldemo8 .modal-body {
                                    background-color: rgb(159 0 0 / 94%);
                                    color: white;
                                }

                                #modaldemo8 .modal-footer {
                                    background-color: rgb(169 0 0 / 94%);
                                    border-top: 1px solid rgb(126 0 0) !important;
                                    color: white;
                                }
                            </style>
                            <!--==========================Delete Modal=================================-->


                            <!----=====================================APP-CONTENT OPEN =========================================-->
                            <div class="main-content app-content mt-0">
                                <div class="side-app">

                                    <!-- CONTAINER -->
                                    <div class="main-container container-fluid">
                                        <br />

                                        <!-- ROW OPEN -->
                                        <div class="row row-cards">
                                            <div class="col-lg-12 col-xl-12">
                                                <div class="input-group mb-5">
                                                    <input type="text" class="form-control" id="searchInput" placeholder="جستجو بر اساس نام مرکز،استان،شهر">
                                                    <div class="input-group-text btn btn-primary" id="userSearch">
                                                        <i class="fa fa-search" aria-hidden="true"></i>
                                                    </div>
                                                </div>
                                                <div class="card">
                                                    <div class="card-header border-bottom-0">
                                                        <a href="#input-modal" data-bs-effect="effect-scale"
                                                            data-bs-toggle="modal"
                                                            class="btn btn-primary modal-effect">افزودن مرکز
                                                            جدید</a>
                                                    </div>
                                                    <div class="e-table px-5 pb-5">
                                                        <div class="table-responsive table-lg">
                                                            <table class="table border-top table-bordered mb-0">
                                                                <thead>
                                                                    <tr>
                                                                        <th>استان</th>
                                                                        <th>شهر</th>
                                                                        <th>نام مرکز</th>
                                                                        <th>روستا</th>
                                                                        <th class="text-center">عملکردها</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <% if(healthCenters){
                                                                        healthCenters.forEach((healthCenter)=>{
                                                                        %>

                                                                        <tr>
                                                                            <td class="text-nowrap align-middle">
                                                                                <%=healthCenter.province%>
                                                                            </td>
                                                                            <td class="text-nowrap align-middle">
                                                                                <%=healthCenter.city%>
                                                                            </td>
                                                                            <td class="text-nowrap align-middle">
                                                                                <%=healthCenter.name%>
                                                                            </td>
                                                                            <td class="text-nowrap align-middle">
                                                                                <%=healthCenter.village%>
                                                                            </td>

                                                                            <td class="text-center align-middle">
                                                                                <div class="btn-group align-top">
                                                                                    <a class="btn btn-sm btn-primary badge modal-effect editHCenter"
                                                                                        data-target="#input-modal"
                                                                                        data-bs-effect="effect-rotate-bottom"
                                                                                        data-bs-toggle="modal"
                                                                                        href="#input-modal"
                                                                                        data-id="<%=healthCenter._id.toString()%>"
                                                                                        type="button">ویرایش</a>
                                                                                    <a class="btn btn-sm btn-danger badge modal-effect deleteModal"
                                                                                        data-bs-effect="effect-super-scaled"
                                                                                        data-id="<%=healthCenter._id.toString()%>"
                                                                                        data-bs-toggle="modal"
                                                                                        href="#modaldemo8"
                                                                                        type="button"><i
                                                                                            class="fa fa-trash"></i></a>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        <% }); } %>

                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-5">
                                                    <ul class="pagination float-end">
                                                        <% let disabled=(page> 1)?'':'disabled';
                                                            let beforePage = page - 1;
                                                            %>
                                                            <li class="page-item page-prev <%=disabled%>">
                                                                <a class="page-link"
                                                                    href="<%=process.env.SITEURL%>/panel/users/<%=beforePage%>">قبلی</a>
                                                            </li>
                                                            <% let before=(page>2)?(page-2):1;
                                                                for(let i=before;i<=page-1;i++){ %>
                                                                    <li class="page-item"><a class="page-link"
                                                                            href="<%=process.env.SITEURL%>/panel/users/<%=i%>">
                                                                            <%=i%>
                                                                        </a></li>
                                                                    <% }%>
                                                                        <li class="page-item active"><a
                                                                                class="page-link"
                                                                                href="javascript:void(0)">
                                                                                <%=page%>
                                                                            </a></li>

                                                                        <% let
                                                                            toPage=((page+7)<=endPage)?(page+7):endPage;
                                                                            for(let i=page+1;i<=toPage;i++){ %>
                                                                            <li class="page-item"><a class="page-link"
                                                                                    href="<%=process.env.SITEURL%>/panel/users/<%=i%>">
                                                                                    <%=i%>
                                                                                </a></li>
                                                                            <% }%>
                                                                                <% let
                                                                                    dis=(page==endPage)?'disabled':'';
                                                                                    let afterPage=page + 1; %>
                                                                                    <li
                                                                                        class="page-item page-next  <%=dis%>">
                                                                                        <a class="page-link"
                                                                                            href="<%=process.env.SITEURL%>/panel/users/<%=afterPage%>">بعدی</a>
                                                                                    </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <!-- COL-END -->
                                        </div>
                                        <!-- ROW CLOSED -->
                                    </div>
                                    <!-- CONTAINER CLOSED -->
                                </div>
                            </div>
                            <!--=============================================== APP-CONTENT CLOSE ==================================-->
                </div>

                <!-- FOOTER -->
                <footer class="footer">

                </footer>
                <!-- FOOTER END -->

            </div>

            <!-- BACK-TO-TOP -->
            <a href="#top" id="back-to-top"><i class="fa fa-angle-up"></i></a>

            <%- include('layout/script.ejs') %>
                <!-- SWEET-ALERT JS -->
                <script src="/assets/plugins/sweet-alert/sweetalert.min.js"></script>
                <script>
                    $(document).ready(() => {
                        let alert = `<%=hCAction%>`;
                        if (alert != null && alert == 'success-delete') {
                            swal({
                                title: "کاربر با موفقیت حذف شد",
                                text: "",
                                confirmButtonText: "تایید",
                                type: "success"
                            });
                        }
                        $('.deleteModal').on('click', (e) => {
                            $('.deleteH').attr('data-id', $(e.target).closest('a').attr('data-id'));
                        })
                        $('.deleteH').on('click', (e) => {
                            let _id = $(e.target).attr('data-id');
                            window.location.href = `<%=process.env.SITEURL%>/panel/hcenters/delete/${_id}`;
                        })
                        let editElm = null;
                        $('.editHCenter').on('click', (e) => {
                            $('#regHCInfo').attr('data-id', $(e.target).closest('a').attr('data-id'));
                            let province = $(e.target).closest('tr').children().eq(0).text().trim();
                            let city = $(e.target).closest('tr').children().eq(1).text().trim();
                            let name = $(e.target).closest('tr').children().eq(2).text().trim();
                            let village = $(e.target).closest('tr').children().eq(3).text().trim();
                            editElm = e;
                            $('#name').val(name);
                            $('#province').val(province);
                            $('#city').val(city);
                            $('#village').val(village);
                            $('#regHCInfo').attr('data-action', 'edit');
                        })
                        $('#regHCInfo').on('click', (e) => {
                            let name = $('#name').val();
                            let province = $('#province').val();
                            let city = $('#city').val();
                            let village = $('#village').val();
                            if ($(e.target).attr('data-action') == 'create') {
                                let data = JSON.stringify({
                                    name, province, city,village
                                });
                                $.ajax({
                                    url: `<%=process.env.SITEURL%>/panel/hcenters/create`,
                                    type: 'post',
                                    dataType: 'json',
                                    contentType: 'application/json',
                                    data: data,
                                    success: (res) => {
                                        if (res.statusCode === 200) {
                                            // Message
                                            swal({
                                                title: 'اطلاعات مرکز با موفقیت ثبت شد',
                                                text: "",
                                                confirmButtonText: "تایید",
                                                type: "success"
                                            });

                                            setTimeout(function () {
                                                window.location.href = `<%=process.env.SITEURL%>/panel/healthcenters`;
                                            }, 500);
                                        }
                                    },
                                    error: function (err) {
                                        console.log(err)
                                    }
                                });
                            } else {
                                $(e.target).attr('data-action', 'create');
                                let data = JSON.stringify({
                                    _id: $(e.target).attr('data-id'),
                                    hInfo: { name, province, city ,village}
                                });
                                $.ajax({
                                    url: `<%=process.env.SITEURL%>/panel/hcenters/edit`,
                                    type: 'post',
                                    dataType: 'json',
                                    contentType: 'application/json',
                                    data: data,
                                    success: (res) => {
                                        if (res.statusCode === 200) {
                                            // Message
                                            $(editElm.target).closest('tr').children().eq(0).text(province);
                                            $(editElm.target).closest('tr').children().eq(1).text(city);
                                            $(editElm.target).closest('tr').children().eq(2).text(name);
                                            $(editElm.target).closest('tr').children().eq(3).text(village);

                                            swal({
                                                title: 'اطلاعات مرکز با موفقیت ثبت شد',
                                                text: "",
                                                confirmButtonText: "تایید",
                                                type: "success"
                                            });
                                            $('#input-modal').modal('hide');
                                        }
                                    },
                                    error: function (err) {
                                        console.log(err)
                                    }
                                });
                            }
                        });
                        $('#userSearch').on('click',()=>{
                            let searchInput = $('#searchInput').val().trim();
                            window.location.href = `<%=process.env.SITEURL%>/panel/hcenters/search/${searchInput}`;
                        })
                    });
                </script>
    </body>


</html>